import scrapy
import time
import os
import requests
import speech_recognition as sr
from pydub import AudioSegment
import undetected_chromedriver as uc
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC

# --- CONFIGURACIÓN GLOBAL DE FFMPEG ---
# Asegúrate de que esta ruta sea correcta en tu PC
ffmpeg_path = r"C:\ffmpeg\bin"
os.environ["PATH"] += os.pathsep + ffmpeg_path
AudioSegment.converter = os.path.join(ffmpeg_path, "ffmpeg.exe")
AudioSegment.ffmpeg = os.path.join(ffmpeg_path, "ffmpeg.exe")
AudioSegment.ffprobe = os.path.join(ffmpeg_path, "ffprobe.exe")

class JudicaturaSpider(scrapy.Spider):
    name = "JUDICATURA"
    allowed_domains = ["procesosjudiciales.funcionjudicial.gob.ec"]
    start_urls = ["https://procesosjudiciales.funcionjudicial.gob.ec/busqueda-filtros"]

    def __init__(self, cedula=None, *args, **kwargs):
        super(JudicaturaSpider, self).__init__(*args, **kwargs)
        self.cedula_objetivo = cedula
        
        # Usamos undetected_chromedriver como en tu script exitoso
        options = uc.ChromeOptions()
        # options.add_argument("--headless") # NO activar headless para evitar detección
        self.driver = uc.Chrome(options=options)

    def encontrar_iframe_con_audio(self):
        """Busca recursivamente el botón de audio dentro de los iframes."""
        print("   -> Buscando botón de audio en iframes...")
        iframes = self.driver.find_elements(By.TAG_NAME, "iframe")
        for index, iframe in enumerate(iframes):
            try:
                self.driver.switch_to.frame(iframe)
                if len(self.driver.find_elements(By.ID, "recaptcha-audio-button")) > 0:
                    print(f"   -> ¡Encontrado en iframe #{index}!")
                    return True
                self.driver.switch_to.default_content()
            except:
                self.driver.switch_to.default_content()
        return False

    def resolver_captcha_automatico(self, wait):
        """
        Lógica completa de bypass de audio integrada.
        """
        print(">>> [ROBOT] Iniciando Protocolo Anti-Captcha...")
        
        # 1. Buscar y Clicar el Checkbox
        iframe_checkbox = wait.until(EC.visibility_of_element_located(
            (By.XPATH, "//iframe[contains(@src, 'recaptcha')]") 
        ))
        self.driver.switch_to.frame(iframe_checkbox)
        
        checkbox = wait.until(EC.element_to_be_clickable((By.ID, "recaptcha-anchor")))
        checkbox.click()
        time.sleep(2)
        
        is_checked = checkbox.get_attribute("aria-checked")
        self.driver.switch_to.default_content()

        if is_checked == "true":
            print(">>> [ROBOT] ¡Pase directo! Google confía en nosotros.")
            return True

        print(">>> [ROBOT] Reto detectado. Iniciando Audio Bypass...")
        time.sleep(3)
        
        # 2. Buscar botón de audio
        if not self.encontrar_iframe_con_audio():
            print("❌ ERROR: No se encontró el botón de audio.")
            return False
        
        # (Ya estamos dentro del iframe gracias a la función anterior)
        btn_audio = wait.until(EC.element_to_be_clickable((By.ID, "recaptcha-audio-button")))
        btn_audio.click()
        print("   -> Botón Audio presionado.")
        
        # 3. Obtener enlace de descarga
        try:
            link_descarga = wait.until(EC.presence_of_element_located(
                (By.CLASS_NAME, "rc-audiochallenge-tdownload-link")
            )).get_attribute("href")
        except:
            print("❌ ERROR: Google bloqueó la descarga temporalmente.")
            return False

        # 4. Descargar Audio (Usando Cookies del Navegador)
        print("   -> Descargando audio...")
        mp3 = "audio.mp3"
        wav = "audio.wav"
        
        headers = {
            "User-Agent": self.driver.execute_script("return navigator.userAgent")
        }
        cookies = self.driver.get_cookies()
        session = requests.Session()
        for cookie in cookies:
            session.cookies.set(cookie['name'], cookie['value'])
        
        response = session.get(link_descarga, headers=headers)
        
        with open(mp3, 'wb') as f:
            f.write(response.content)

        # 5. Procesar Audio
        print("   -> Convirtiendo y Transcribiendo...")
        try:
            sound = AudioSegment.from_mp3(mp3)
            sound.export(wav, format="wav")
            
            recognizer = sr.Recognizer()
            with sr.AudioFile(wav) as source:
                audio_data = recognizer.record(source)
                texto = recognizer.recognize_google(audio_data, language="en-US")
            
            print(f"   -> CÓDIGO DESCIFRADO: {texto}")
            
            # 6. Enviar Solución
            self.driver.find_element(By.ID, "audio-response").send_keys(texto)
            time.sleep(1)
            self.driver.find_element(By.ID, "recaptcha-verify-button").click()
            print("   -> Verificación enviada.")
            self.driver.switch_to.default_content()
            
            # Limpieza de archivos temporales
            try:
                os.remove(mp3)
                os.remove(wav)
            except: pass
            
            return True
            
        except Exception as e:
            print(f"❌ Error en procesamiento de audio: {e}")
            return False

    def parse(self, response):
        self.driver.get(response.url)
        wait = WebDriverWait(self.driver, 40)

        try:
            # --- PASO 1: INPUT DATOS ---
            print(">>> [1/4] Ingresando datos...")
            cedula_input = wait.until(EC.presence_of_element_located(
                (By.CSS_SELECTOR, "input[formcontrolname='cedulaDemandado']")
            ))
            valor = self.cedula_objetivo if self.cedula_objetivo else "0802011379"
            cedula_input.send_keys(valor)

            print(">>> [2/4] Clic en primer BUSCAR...")
            btn_buscar = wait.until(EC.element_to_be_clickable(
                (By.CSS_SELECTOR, "button[aria-label='Enviar formulario']")
            ))
            btn_buscar.click()

            # --- PASO 2: RESOLVER CAPTCHA (AUTOMÁTICO) ---
            exito_captcha = self.resolver_captcha_automatico(wait)
            
            if not exito_captcha:
                print("❌ EL CAPTCHA FALLÓ. Abortando.")
                self.driver.quit()
                return

            # --- PASO 3: CLICK EN BUSCAR FINAL ---
            print(">>> [3/4] Clic en BUSCAR Final...")
            # Esperamos a que el botón vuelva a ser clickeable tras el captcha
            time.sleep(3) 
            btn_buscar_final = wait.until(EC.element_to_be_clickable(
                (By.CSS_SELECTOR, "button[aria-label='Enviar formulario']")
            ))
            btn_buscar_final.click()

            # --- PASO 4: EXTRACCIÓN DE DATOS ---
            print(">>> [4/4] Esperando resultados...")
            
            # Esperamos a que aparezca el contenedor de resultados
            # Usamos un tiempo largo porque a veces la web es lenta tras el captcha
            WebDriverWait(self.driver, 20).until(
                EC.presence_of_element_located((By.CSS_SELECTOR, "div.lista-causa"))
            )
            
            # Buscamos las filas (Divs)
            filas = self.driver.find_elements(By.CSS_SELECTOR, "div.causa-individual")
            print(f">>> SISTEMA: Se encontraron {len(filas)} registros.")

            for fila in filas:
                try:
                    item = {
                        'fecha': fila.find_element(By.CSS_SELECTOR, "div.fecha").text,
                        'id_proceso': fila.find_element(By.CSS_SELECTOR, "div.numero-proceso").text,
                        'accion': fila.find_element(By.CSS_SELECTOR, "div.accion-infraccion").text,
                        'detalle': "Carpeta Virtual"
                    }
                    try:
                        link = fila.find_element(By.TAG_NAME, "a").get_attribute("href")
                        item['link'] = link
                    except:
                        item['link'] = "No disponible"
                    
                    yield item
                except Exception as e:
                    print(f"Error leyendo fila: {e}")

        except Exception as e:
            print(f"❌ ERROR GENERAL: {e}")
        
        print(">>> Finalizando...")
        time.sleep(2)
        self.driver.quit()
